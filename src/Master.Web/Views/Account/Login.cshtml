
@using Abp.Extensions
@using Abp.MultiTenancy
@using Master;
@using Abp.Web.Security.AntiForgery
@using Master.Configuration;
@inject IAbpAntiForgeryManager AbpAntiForgeryManager
@inject WebCoreConfiguration WebCoreConfiguration
@model Master.Web.Models.Account.LoginFormViewModel
@{
    //登录页
	Layout = null;
	//var softTitle = await SettingManager.GetSettingValueForApplicationAsync(AppSettingNames.SoftTitle);
	var softTitle = WebCoreConfiguration.SoftName;
	AbpAntiForgeryManager.SetCookie(Context);
}



<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>@softTitle - @L("登录")</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link href="~/view-resources/Views/_Bundles/base.min.css" rel="stylesheet" asp-append-version="true" />
    <script src="/assets/layuiadmin/layui/layui.js" asp-append-version="true"></script>
    <script src="~/view-resources/Views/_Bundles/base.min.js" asp-append-version="true"></script>
    <script src="~/view-resources/Views/_Bundles/abp.min.js" asp-append-version="true"></script>
    <script src="~/assets/js/global.js" asp-append-version="true"></script>
    <script src="~/scripts/GetAll.js" type="text/javascript"></script>
    @*<script src="~/scripts/GetScripts.js?v=@(AppTimes.StartupTime.Ticks)" type="text/javascript"></script>*@
    @*<script src="~/AbpServiceProxies/GetAll?v=@(AppTimes.StartupTime.Ticks)" type="text/javascript"></script>*@
    <script src="~/AbpScripts/GetScripts" type="text/javascript"></script>
    @*<script>if (window.top !== window.self) { window.top.location = window.location; }</script>*@
    
</head>
<body>
    <div id="app">
        <!--这是扫码登录二维码-->
        <img id="codeImg" :src="qrCode" width="250" />
    </div>
    


	<script>
		var guid = "@ViewBag.Guid";
		var app = new Vue({
				el: '#app',
				computed: {
					qrCode: function () {
						return '/api/qrcode?url=' + encodeURIComponent(location.origin + "/WeiXin/LoginCallback?guid=" + guid);
					}
				}
			});
            //轮询请求
        var loopFunc = function () {
                //获取用户信息
				abp.services.app.weiXin.getLoginInfo().done(function (data) {                    
                    if (data) {
                        var openid = data.openid;
                        var nickname = data.nickname;//用户昵称
                        var headimgurl = data.headimgurl;//头像
                        //根据openid去寻找用户的账号信息
                        abp.services.app.user.getUserStatusByWeOpenId(openid).done(function (status) {
                            //status的四种值：1:正常登录，-1:被注销，2：未注册,3:审核中
                            //todo:根据不同状态进行不同操作
                            if (status == 1) {
                                var authModel = {
                                    authProvider: "Wechat",
                                    providerKey: openid,
                                    providerAccessCode: "",
                                    clientInfo: 'Browser'
                                };
                                //window.clearInterval(loop);
                                doExternalAuthentication(authModel);
                            }
                        })
						
					} else {
						window.setTimeout(loopFunc, 1000);
					}


				});
			}
			loopFunc();

        //第三方登录接口
        function doExternalAuthentication(authModel) {
            console.log(authModel);
            abp.ui.setBusy(
                $('body'),

                abp.ajax({
                    contentType: "application/x-www-form-urlencoded",
                    url: "/api/tokenauth/externalAuthenticate",
                    data: authModel,
                    success: function (data) {
                        console.log(data);
                        $.cookie("token", data.encryptedAccessToken, { path: '/' });
                        $.removeCookie("simulateLogin", { path: '/' });
                        location.href = '/';

                    }
                })
            );
        }
	</script>
</body>
</html>

